---
import type { MarkdownHeading } from "astro";
import type { NavTreeItem } from "../../utils/routing";
import { pathWithBase } from "../../utils/base";

interface Props {
  entries: NavTreeItem[];
  headings?: MarkdownHeading[] | undefined;
  nested?: boolean;
}

function hasCurrent(entry: NavTreeItem) {
  if (entry.isCurrent) {
    return true;
  }

  if (entry.children) {
    return entry.children.some(hasCurrent);
  }

  return false;
}

const { entries, nested, headings } = Astro.props;
---

<ul class:list={{ "top-level": !nested }}>
  {
    entries.map((entry) => (
      <li>
        {!entry.children && (
          <>
            <a
              href={pathWithBase(entry.url || "")}
              class:list={[
                entry.isCurrent ? "current" : "",
                entry.isCurrent && headings && headings.length > 0
                  ? "with-headings"
                  : "",
              ]}
            >
              {entry.title}
            </a>
            {entry.isCurrent && headings && headings.length > 0 && (
              <ul class="headings">
                {headings.map((heading) => (
                  <li class={`heading-${heading.depth}`}>
                    <a href={`#${heading.slug}`}>{heading.text}</a>
                  </li>
                ))}
              </ul>
            )}
          </>
        )}
        {entry.children && (
          <details open={hasCurrent(entry)}>
            <summary>
              <a
                href={pathWithBase(entry.url || "")}
                class:list={[entry.isCurrent ? "current" : ""]}
              >
                {entry.title}
              </a>
            </summary>
            <Astro.self
              entries={entry.children}
              nested={true}
              headings={headings}
            />
          </details>
        )}
      </li>
    ))
  }
</ul>

<style lang="scss">
  summary {
    position: relative;
    display: flex;
    list-style: none;

    &::marker,
    &::-webkit-details-marker {
      display: none;
    }

    &::before {
      content: "â–¸";
      left: -1.5em;
      color: var(--clr-accent);
      padding: 0 0.5rem;
      position: absolute;
      transition: transform 0.1s ease-in-out;
      cursor: pointer;
    }

    a {
      flex-grow: 1;
    }
  }

  details {
    &[open] summary::before {
      transform: rotate(90deg);
    }
  }

  ul {
    list-style: none;
    margin: 0 0 0.5rem;
    padding: 0 0 0 1rem;
    height: 100%;

    &.top-level {
      overflow-x: visible;
      overflow-y: auto;
      // We need this so that the arrows that show/hide the
      // details are not hidden by overflow
      margin-left: -2rem;
      padding-left: 2rem;
      border-left: none;
    }

    &.headings {
      list-style: disc;
      background-color: #eee6;
      padding: 0.5rem;
      border-left: none;
      margin-left: 0;
      border-radius: 0 0 0.5em 0.5em;

      li {
        display: list-item;
        line-height: 1;
        margin-bottom: 0.5em;

        &::marker {
          color: var(--clr-accent);
        }
      }

      a {
        padding: 0;

        &:hover {
          background: none;
          text-decoration: underline solid var(--clr-accent);
        }
      }
    }
  }

  li {
    display: flex;
    flex-direction: column;
  }

  a {
    position: relative;
    text-decoration: none;
    padding: 0.5em 0.5rem;
    border-radius: 0.5em;
    line-height: 1;

    &.current {
      font-weight: bold;
      background: var(--clr-secondary);

      &.with-headings {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }
    }

    &:hover {
      transform: scale(1.02);
    }
  }

  @for $i from 1 through 6 {
    .heading-#{$i} {
      margin-left: calc(1.5rem * #{max($i - 1, 0)});
    }
  }
</style>
